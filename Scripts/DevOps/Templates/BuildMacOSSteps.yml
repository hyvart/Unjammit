# Expected variables:
#   - BuildConfiguration
#   - DotNetCoreSdk.Version
#   - MSBuild.MSBuildArchitecture
#   - XamarinMac.MonoVersion

parameters:
  project:
  msbuildArguments: ''
  debug: false

steps:
  - template: SetMacOSFrameworkVersion.yml
    parameters:
      framework: Mono
      version: $(XamarinMac.MonoVersion)

  - task: DotNetCoreInstaller@1
    displayName: Install .NET Core $(DotNetCoreSdk.Version)
    inputs:
      packageType: sdk
      version: $(DotNetCoreSdk.Version)

  - task: UseDotNet@2
    displayName: Use .NET Core $(DotNetCoreSdk.Version)
    inputs:
      packageType: sdk
      version: $(DotNetCoreSdk.Version)

  - task: MSBuild@1
    displayName: Restore Packages
    inputs:
      solution: ${{ parameters.project }}
      msbuildArchitecture: $(MSBuild.MSBuildArchitecture)
      msbuildArguments: /t:Restore

  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: com.unjammit.mac.app.p12
      certPwd: $(SigningKeyPassword)

  - task: InstallAppleProvisioningProfile@1
    displayName: Install Provisioning Profile
    inputs:
      provProfileSecureFile: com.unjammit.mac.alpha.mobileprovision

  # TODO: Replace with MSBuildSteps
  - task: MSBuild@1
    displayName: Build ${{ parameters.project }}
    inputs:
      solution: ${{ parameters.project }}
      msbuildArchitecture: $(MSBuild.MSBuildArchitecture)
      configuration: $(BuildConfiguration)
      platform: AnyCPU
      msbuildArguments:
        ${{ parameters.msbuildArguments }}
      maximumCpuCount: $(MSBuild.MaximumCpuCount)
